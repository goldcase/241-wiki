<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
	<link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>
<body>
<p>Each thread uses a stack memory. The stack 'grows downwards' - if a function calls another function, then the stack is extended to smaller memory addresses.<br />
Stack memory includes non-static automatic (temporary) variables, parameter values and the return address.<br />
If a buffer is too small some data (e.g. input values from the user), then there is a real possibility that other stack variables and even the return address will be overwritten.<br />
The precise layout of the stack's contents and order of the automatic variables is architecture and compiler dependent. However with a little investigative work we can learn how to deliberately smash the stack for a particular architecture.</p>
<p>The example below demonstrates how the return address is stored on the stack. For a particular 32 bit architecture <a href="http://cs-education.github.io/sys/">Live Linux Machine</a>, we determine that the return address is stored at an address two pointers (8 bytes) above the address of the automatic variable. The code deliberately changes the stack value so that when the input function returns, rather than continuing on inside the main method, it jumps to the exploit function instead.</p>
<div class="highlight"><pre><span class="c1">// Overwrites the return address on the following machine:</span>
<span class="c1">// http://cs-education.github.io/sys/</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>

<span class="kt">void</span> <span class="nf">breakout</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Welcome. Have a shell...&quot;</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">input</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Address of stack variable: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Something that looks like a return address on stack: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="o">&amp;</span><span class="n">p</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>
  <span class="c1">// Let&#39;s change it to point to the start of our sneaky function.</span>
  <span class="o">*</span><span class="p">((</span><span class="o">&amp;</span><span class="n">p</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">breakout</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;main() code starts at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">main</span><span class="p">);</span>

    <span class="n">input</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
    <script src="check_mc.js"></script>
</body>
</html>
</body>
</html>
