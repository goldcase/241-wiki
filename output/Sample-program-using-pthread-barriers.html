<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
	<link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>
<body>
<div class="highlight"><pre><span class="cp">#define _GNU_SOURCE</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;pthread.h&gt;</span>
<span class="cp">#include &lt;time.h&gt;</span>

<span class="cp">#define THREAD_COUNT 4</span>

<span class="kt">pthread_barrier_t</span> <span class="n">mybarrier</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">threadFn</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">id_ptr</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">thread_id</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">id_ptr</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">wait_sec</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">5</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;thread %d: Wait for %d seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">,</span> <span class="n">wait_sec</span><span class="p">);</span>
  <span class="n">sleep</span><span class="p">(</span><span class="n">wait_sec</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;thread %d: I&#39;m ready...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">);</span>

  <span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mybarrier</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;thread %d: going!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">pthread_t</span> <span class="n">ids</span><span class="p">[</span><span class="n">THREAD_COUNT</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">short_ids</span><span class="p">[</span><span class="n">THREAD_COUNT</span><span class="p">];</span>

  <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
  <span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mybarrier</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">THREAD_COUNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">THREAD_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">short_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">threadFn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">short_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;main() is ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mybarrier</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;main() is going!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">THREAD_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">pthread_barrier_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mybarrier</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
    <script src="check_mc.js"></script>
</body>
</html>
</body>
</html>
